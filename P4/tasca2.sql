PRAGMA foreign_key = ON;
DROP TABLE IF EXISTS CLIENTS;
DROP TABLE IF EXISTS CENTRES;
DROP TABLE IF EXISTS COMANDES;
DROP TABLE IF EXISTS VENEDORS;
DROP TABLE IF EXISTS PRODUCTES;

CREATE TABLE CLIENTS(
    NIF CHAR(9) NOT NULL PRIMARY KEY ,
    RAOSOCIAL TEXT,
    ADRECA TEXT NOT NULL,
    TELEFON CHAR(9) NOT NULL,
    DESCOMPTE INT );

CREATE TABLE CENTRES(
    CODI_CEN INT(2),
    CIUTAT VARCHAR,
    ZONA VARCHAR,
    PRIMARY KEY(CODI_CEN));
CREATE TABLE COMANDES(
    NUMCOMANDA INT(3) /*NOT NULL AUTO_INCREMENT*/,
    CODIPRODUCTE INT(4) NOT NULL,
    CODIVENEDOR INT(2)  NOT NULL,
    NIF CHAR(9) NOT NULL,
    DATA DATE,
    UNITATS INT(3),
    PRIMARY KEY(NUMCOMANDA),
    FOREIGN KEY (CODIPRODUCTE) REFERENCES PRODUCTES(CODI_PRO),
    FOREIGN KEY (CODIVENEDOR) REFERENCES VENEDORS(CODI_VEN),
    FOREIGN KEY (NIF) REFERENCES CLIENTS(NIF));

CREATE TABLE VENEDORS(
    CODI_VEN INT(2) /*NOT NULL AUTO_INCREMENT*/ PRIMARY KEY ,
    NOM VARCHAR,
    EDAT INT,
    CODICENTRE INT,
    FOREIGN KEY (CODICENTRE) REFERENCES CENTRES(CODI_CEN));

CREATE TABLE PRODUCTES(
    CODI_PRO INT(4) /*NOT NULL AUTO_INCREMENT*/ PRIMARY KEY,
    DESCRIPCIO CHAR(20),
    PREU INT(5),
    ESTOC INT );

INSERT INTO CLIENTS VALUES("11111111Z","PAO","CARRE1","111111111",0);
INSERT INTO CLIENTS VALUES("22222222A","RAO1","CARRER2","222222222",0);
INSERT INTO CLIENTS VALUES("33333333B","RAO2","CARRER3","333333333",0);
INSERT INTO CLIENTS VALUES("44444444B","RAO2","CARRER3","444444443",0);


INSERT INTO CENTRES VALUES(1,"Barcelona","Centro");
INSERT INTO CENTRES VALUES(2,"Barcelona","Centro1");
INSERT INTO CENTRES VALUES(3,"B","Terrasa");

INSERT INTO COMANDES VALUES(1,2,2,"11111111Z","2016-04-26",2);
INSERT INTO COMANDES VALUES(2,1,3,"22222222A","2016-05-21",2);
INSERT INTO COMANDES VALUES(3,3,1,"33333333B",DATE('now'),3);
INSERT INTO COMANDES VALUES(4,1,1,"11111111Z","2016-05-05",2);

INSERT INTO VENEDORS VALUES(1,"Pavel",24,2);
INSERT INTO VENEDORS VALUES(2,"Adri",28,3);
INSERT INTO VENEDORS VALUES(3,"Alex",25,1);
INSERT INTO VENEDORS VALUES(4,"Pavel1",24,2);
INSERT INTO VENEDORS VALUES(5,"Adri1",28,3);
INSERT INTO VENEDORS VALUES(6,"Alex1",25,1);
INSERT INTO VENEDORS VALUES(7,"Pavel2",24,2);
INSERT INTO VENEDORS VALUES(8,"Adri2",28,3);
INSERT INTO VENEDORS VALUES(9,"Alex2",25,1);
INSERT INTO VENEDORS VALUES(10,"Pavel3",24,2);
INSERT INTO VENEDORS VALUES(11,"Adri3",28,3);
INSERT INTO VENEDORS VALUES(12,"Alex3",35,1);

INSERT INTO PRODUCTES VALUES(1,"Monitor",50,5);
INSERT INTO PRODUCTES VALUES(2,"Monitor",10,3);
INSERT INTO PRODUCTES VALUES(3,"Portatil",250,2);
INSERT INTO PRODUCTES VALUES(4,"TV",250,0);

.header ON
.mode column

/*.print "Tasca1"*/
/*  Eliminina productes sense estoc */
/*EXEMPLE 1*/
/*DELETE FROM PRODUCTES WHERE ESTOC=0;
SELECT * from PRODUCTES;
/*EXEMPLE 2*/
 /*MODIFICA 3 PRIMEROS CLIENTES QUE RECIBAN BONIFICACION DE 1.5% POR SUS COMPRAS*/
/*UPDATE CLIENTS SET DESCOMPTE=DESCOMPTE+1.5 LIMIT 3;*/

/* EXEMPLE 3  */
SELECT  * FROM PRODUCTES P WHERE P.DESCRIPCIO LIKE "Monitor%";
/*EXEMPLE 4*/
SELECT C.*, V.NOM, V.EDAT FROM CENTRES C INNER JOIN VENEDORS V ON C.CODI_CEN=V.CODICENTRE  AND V.EDAT BETWEEN 21 AND 26 ORDER BY V.EDAT ASC;
/*EXEMPLE 5*/
SELECT C.NIF, SUM(P.PREU * C.UNITATS*(100-CL.DESCOMPTE)/100) AS TOTAL_COMANDA FROM COMANDES C INNER JOIN CLIENTS CL ON (C.NIF = CL.NIF)  AND (C.DATA BETWEEN "2016-01-01" AND "2017-01-01") INNER JOIN PRODUCTES  P ON C.CODIPRODUCTE=P.CODI_PRO GROUP BY C.NIF;

/*EXEMPLE6*/
SELECT V.*, SUM(C.UNITATS) FROM VENEDORS V LEFT JOIN COMANDES C ON C.CODIVENEDOR = V.CODI_VEN GROUP BY V.CODI_VEN LIMIT 10;
/*OBTENIR LLISTAT DE PRODUCTES INACTIUS, QUE NO APREIXEN EN LES COMANDES*/
SELECT P.*  FROM PRODUCTES P  LEFT JOIN COMANDES C ON P.CODI_PRO=C.CODIPRODUCTE  WHERE C.CODIPRODUCTE IS NULL;
